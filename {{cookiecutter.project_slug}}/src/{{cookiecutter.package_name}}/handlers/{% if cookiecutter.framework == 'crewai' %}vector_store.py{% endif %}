"""CrewAI vector store manager with Langchain integration."""
import chromadb
from langchain.vectorstores import Chroma
from langchain.embeddings import OpenAIEmbeddings
from langchain.chat_models import ChatOpenAI
from langchain.callbacks import get_openai_callback
from crewai import Agent
import tiktoken
from ..config import settings

class VectorStoreManager:
    """Singleton manager for CrewAI and vector store resources."""
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(VectorStoreManager, cls).__new__(cls)
            cls._instance._initialize()
        return cls._instance

    def _initialize(self):
        """Initialize CrewAI and Langchain components."""
        # Initialize embeddings
        self.embeddings = OpenAIEmbeddings()
        
        # Initialize LLM
        self.llm = ChatOpenAI(
            model_name="gpt-3.5-turbo",
            temperature=0
        )

        # Initialize vector store
        {% if cookiecutter.use_persistent_chroma == "y" %}
        self.store = Chroma(
            persist_directory=settings.chroma_db_path,
            embedding_function=self.embeddings
        )
        {% else %}
        self.store = Chroma(
            embedding_function=self.embeddings
        )
        {% endif %}

        # Initialize token counter
        self.token_counter = get_openai_callback()
        self.token_counter.__enter__()

        # Initialize base agents
        self.base_agents = {
            'researcher': Agent(
                role='Research Analyst',
                goal='Find and analyze information effectively',
                backstory='Expert at research and analysis',
                verbose=True
            ),
            'writer': Agent(
                role='Technical Writer',
                goal='Compose clear and accurate content',
                backstory='Expert at technical writing and explanation',
                verbose=True
            ),
            'reviewer': Agent(
                role='Content Reviewer',
                goal='Ensure accuracy and quality',
                backstory='Expert at quality assurance and verification',
                verbose=True
            )
        }

    def get_token_counts(self):
        """Get current token counts and reset counter."""
        counts = {
            "embedding_tokens": self.token_counter.prompt_tokens,  # Approximation
            "llm_prompt_tokens": self.token_counter.prompt_tokens,
            "llm_completion_tokens": self.token_counter.completion_tokens,
            "total_llm_tokens": self.token_counter.total_tokens
        }
        # Reset counter by creating a new callback context
        self.token_counter.__exit__(None, None, None)
        self.token_counter = get_openai_callback()
        self.token_counter.__enter__()
        return counts

    def get_agent(self, role: str) -> Agent:
        """Get a pre-configured agent by role."""
        return self.base_agents.get(role) 